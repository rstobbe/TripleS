%========================================================
% 
%========================================================

function [Tout] = SpinDynamicsRobTotal3(t,w1,A,wof,wq,J0,J1,J2,Tin)

%Rotate
Tin = PhaseChange(A,Tin);

%Excitation
Ex =     [0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % Constant
          0    ,    0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T10
          0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T11(s)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T11(a)
          0    ,    0    ,    0    ,    0    ,    0, -i*sqrt(3)*w1,   0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T20
          0    ,    0    ,    0    ,    0,   -i*sqrt(3)*w1, 0    ,    0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T21(s)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T21(a)
          0    ,    0    ,    0    ,    0    ,    0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T22(s)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  -i*w1  ,    0    ,    0    ,    0    ,    0    ,    0    ,    0     ,     0     ,     0     ,     0; ...         % T22(a)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0,   -i*sqrt(6)*w1, 0    ,    0     ,     0     ,     0     ,     0; ...         % T30
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0, -i*sqrt(6)*w1,   0    ,    0 , -i*sqrt(5/2)*w1,  0     ,     0     ,     0; ...         % T31(s)      
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0, -i*sqrt(5/2)*w1,     0     ,     0; ...         % T31(a)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0, -i*sqrt(5/2)*w1, 0    ,    0     ,     0 , -i*sqrt(3/2)*w1,    0; ...         % T32(s)    
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0,-i*sqrt(5/2)*w1,  0     ,     0     ,     0, -i*sqrt(3/2)*w1; ...    % T32(a)
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 , -i*sqrt(3/2)*w1,  0     ,     0     ,     0; ...         % T33(s)   
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 ,  -i*sqrt(3/2)*w1,   0     ,     0];            % T33(a)
  
% Off Resonance
Off =    [0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...      
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*2*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*2*wof ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   i*wof ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*2*wof ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*2*wof ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*3*wof; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , i*3*wof ,    0]; 
  
%Residual Quadrupolar Interaction
Qres =   [0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0, i*sqrt(3/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0, i*sqrt(3/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0, i*sqrt(3/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0, i*sqrt(2/5)*wq,  0    ,    0    ,    0    ,    0; ...
          0    ,    0, i*sqrt(3/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0, i*sqrt(2/5)*wq,  0    ,    0    ,    0    ,    0    ,    0; ...      
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  i*wq   ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  i*wq   ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0, i*sqrt(2/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0, i*sqrt(2/5)*wq,  0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  i*wq   ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  i*wq   ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0]; 

%J1 / J2 components of relaxation
Rlx_J1J2=[0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
-0.4*J1-1.6*J2 ,0.4*J1+1.6*J2,0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0  , 0.8*J1-0.8*J2, 0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,J1+0.4*J2,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 ,-(sqrt(6)/5)*J2, 0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,J1+0.4*J2,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 ,-(sqrt(6)/5)*J2, 0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,2*J1+2*J2,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    , J1+2*J2 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    , J1+2*J2 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...      
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , 2*J1+J2 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    , 2*J1+J2 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
-0.8*J1+0.8*J2 ,0.8*J1-0.8*J2,0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0  ,1.6*J1+0.4*J2,  0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0 ,-(sqrt(6)/5)*J2, 0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,J1+0.6*J2,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0 ,-(sqrt(6)/5)*J2, 0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,J1+0.6*J2,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J2    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J2    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  J1+J2  ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,J1+J2];   
 
%J0 component of relaxation        
Rlx_J0 = [0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,  0.6*J0 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 , (sqrt(6)/5)*J0, 0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,  0.6*J0 ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0 , (sqrt(6)/5)*J0, 0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...      
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0 , (sqrt(6)/5)*J0, 0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  0.4*J0 ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0 , (sqrt(6)/5)*J0, 0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,  0.4*J0 ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,   J0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0; ...
          0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0    ,    0];
    
M = Ex + Off + Qres - Rlx_J1J2 - Rlx_J0;

[V,D] = eig(M);

sol = exp(D*t) .* eye(16);

Tout = V * sol * V^-1 * Tin;

Tout = PhaseChange(-A,Tout);

test = 0;